<?xml version='1.1' encoding='UTF-8'?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->
<xwikidoc version="1.4" reference="AdminTools.Code.Macros" locale="">
  <web>AdminTools.Code</web>
  <name>Macros</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <parent>AdminTools.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <version>1.1</version>
  <title>Macros</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity output='false'}}
#macro (viewLastNLinesMoldal $id)
  #set ($modalId = $id + 'ViewLastNLinesModal')
  &lt;div class="modal fade" id="${modalId}" tabindex="-1" role="dialog" aria-labelledby="${modalId}Label">
    &lt;div class="modal-dialog modal-sm" role="document">
      &lt;div class="modal-content">
        &lt;div class="logs-modal-content">
          &lt;div class="modal-header">
            &lt;button type="button" class="close" data-dismiss="modal" aria-label="Close">
              &lt;span aria-hidden="true">&amp;times;&lt;/span>&lt;/button>
            &lt;h1 class="modal-title">
              $escapetool.xml($services.localization.render('adminTools.dashboard.logs.modal.title'))
            &lt;/h1>
          &lt;/div>
          &lt;div class="modal-body">
            &lt;form class="xform" action="$request.getContextPath()/rest/admintools/files/logs">
              &lt;dl>
                &lt;dt>
                  &lt;label for="noLines">$escapetool.xml($services.localization.render(
                    'adminTools.dashboard.logs.modal.nLines.label')) &lt;/label>
                  &lt;span class="xHint">$escapetool.xml($services.localization.render(
                    'adminTools.dashboard.logs.modal.nLines.hint'))&lt;/span>
                &lt;/dt>
                &lt;dd>&lt;input type="number" name="noLines" placeholder="1000">&lt;/dd>
              &lt;/dl>
            &lt;/form>
          &lt;/div>
          &lt;div class="modal-footer">
            &lt;button type="button" class="btn btn-primary">
              $escapetool.xml($services.localization.render('adminTools.dashboard.logs.modal.submit'))&lt;/button>
            &lt;button type="button" class="btn btn-default" data-dismiss="modal">
              $escapetool.xml($services.localization.render('cancel'))&lt;/button>
          &lt;/div>
        &lt;/div>
      &lt;/div>
    &lt;/div>
  &lt;/div>
#end

#macro (downloadArchiveModal)
  &lt;div class="modal fade" id="downloadFilesModal" tabindex="-1" role="dialog" aria-labelledby=
    "downloadFilesModalLabel">
    &lt;div class="modal-dialog" role="document">
      &lt;div class="modal-content">
        &lt;div class="modal-header">
          &lt;button type="button" class="close" data-dismiss="modal" aria-label="Close">
            &lt;span aria-hidden="true">&amp;times;&lt;/span>&lt;/button>
          &lt;h1 class="modal-title">
            $escapetool.xml($services.localization.render('adminTools.dashboard.download.modal.title'))
          &lt;/h1>
        &lt;/div>
        &lt;div class="modal-body">
          &lt;form class="xform" action="$request.getContextPath()/rest/admintools/files">
            &lt;div class="download-modal-content">
              &lt;dl>
                &lt;dt>&lt;label>&lt;input type="checkbox" name="files" value="xwikiConfig" checked>
                    $escapetool.xml($services.localization.render(
                    'adminTools.dashboard.download.modal.xwikiConfig.title'))
                  &lt;/label>
                &lt;/dt>
                &lt;dt>&lt;label>&lt;input type="checkbox" name="files" value="xwikiProperties" checked>
                    $escapetool.xml($services.localization.render(
                    'adminTools.dashboard.download.modal.xwikiProperties.title'))
                  &lt;/label>
                &lt;/dt>
                &lt;dt>
                  &lt;label>&lt;input type="checkbox" name="files" value="dataProvider" checked>
                    $escapetool.xml($services.localization.render('adminTools.dashboard.download.modal.provided'))
                  &lt;/label>
                &lt;/dt>
                &lt;dt>
                  &lt;label>&lt;input type="checkbox" name="files" value="logs" checked>
                    $escapetool.xml($services.localization.render('adminTools.dashboard.download.modal.logs.title'))
                  &lt;/label>
                &lt;/dt>
                &lt;dt>
                  &lt;div class="dateFields">
                    #set ($defaultDateFormat = 'dd-MM-yyyy')
                    #set ($dateFormat = $xwiki.getXWikiPreference('dateformat', $defaultDateFormat))
                    &lt;label for="downloadFilesModalFromDate">$escapetool.xml($services.localization.render(
                      'adminTools.dashboard.download.modal.date.from'))
                    &lt;/label>
                    #set ($dateFromParams = {
                      'id': "downloadFilesModalFromDate",
                      'name': 'from',
                      'data-format': $dateFormat,
                      'placeholder': $escapetool.xml($services.localization.render(
                        'adminTools.dashboard.download.modal.logs.filter.placeholder.from'))
                    })
                    #dateTimePicker($dateFromParams)
                    &lt;label for="downloadFilesModalToDate">$escapetool.xml($services.localization.render(
                      'adminTools.dashboard.download.modal.date.to'))
                    &lt;/label>
                    #set ($dateToParams = {
                      'id': "downloadFilesModalToDate",
                      'name': 'to',
                      'data-format': $dateFormat,
                      'placeholder': $escapetool.xml($services.localization.render(
                        'adminTools.dashboard.download.modal.logs.filter.placeholder.to'))
                    })
                    #dateTimePicker($dateToParams)
                  &lt;/div>
                &lt;/dt>
              &lt;/dl>
            &lt;/div>
          &lt;/form>
        &lt;/div>
        &lt;div class="modal-footer">
          &lt;button type="button" class="btn btn-primary">
            $escapetool.xml($services.localization.render('adminTools.dashboard.download.modal.button'))&lt;/button>
          &lt;button type="button" class="btn btn-default" data-dismiss="modal">
            $escapetool.xml($services.localization.render('cancel'))&lt;/button>
        &lt;/div>
      &lt;/div>
    &lt;/div>
  &lt;/div>
#end

#macro (jobFinishedMessage $status $translationPrefix $successKey $errorKey $canceledKey $warningKey)
  #if ($status.error)
    #set($messageKeys = [$errorKey, "${translationPrefix}.finish.error", "job.status.${status.jobType}.error", 'job.status.error'])
    #set($healthCheckReportMessage = $services.localization.render($messageKeys))
    #set($messageClass = 'errormessage')
  #elseif ($status.canceled)
    #set($messageKeys = [$canceledKey, "${translationPrefix}.finish.canceled", "job.status.${status.jobType}.canceled", 'job.status.canceled'])
    #set($healthCheckReportMessage = $services.localization.render($messageKeys))
    #set($messageClass = 'warningmessage')
  #elseif ($status.logTail.hasLogLevel('error'))
    #set($healthCheckReportMessage = 'Critical issues were found, please consult the log!')
    #set($messageClass = 'errormessage')
  #elseif ($status.logTail.hasLogLevel('warn'))
    #set($healthCheckReportMessage = 'Some issues have been found, for more details please see the log.')
    #set($messageClass = 'warningmessage')
  #else
    #set($healthCheckReportMessage = 'No issue found!')
    #set($messageClass = 'successmessage')
  #end
  &lt;div class="box $messageClass">
    $healthCheckReportMessage
  &lt;/div>
#end

#macro (healthCheckUI)
  #set ($discard = $xwiki.jsx.use('AdminTools.Code.AdminToolsJS'))
  #set ($healthCheckJobRequest = $services.admintools.createJobRequest($services.wiki.getCurrentWikiId()))
  #set ($jobId = $healthCheckJobRequest.id)
  #set ($healthJobStatusURL = $xwiki.getURL('AdminTools.Code.HealthCheckJob', 'get', $escapetool.url({
    'jobId': $jobId,
    'outputSyntax': 'plain'
  })))
  #if ($jobId)
    #set ($healthJobStatus = $services.job.getJobStatus($jobId))
  #end
  #set($solutionLink = $xwiki.getURL('AdminTools.HelpLinks'))
  #set ($description = $escapetool.xml($services.localization.render('adminTools.dashboard.healthcheck.description', [
    '__STARTLINK__',
    '__ENDLINK__'
  ])).replace('__STARTLINK__', "&lt;a href='$solutionLink'>&lt;strong>").replace('__ENDLINK__', '&lt;/strong>&lt;/a>'))
  {{html clean='false'}}
    &lt;input type="hidden" name="jobState" value="${healthJobStatus.state}">&lt;/input>
    &lt;div class="adminToolsDashboardItem" id="healthCheck">
      &lt;h2>$services.icon.renderHTML('bug')
        $escapetool.xml($services.localization.render('adminTools.dashboard.healthcheck.title'))&lt;/h2>
      &lt;p>$description&lt;/p>
      &lt;hr/>
      &lt;div class="healthCheckWrapper">
        &lt;div class="healthCheckLastCheck">
          Time since the last health check: $services.date.displayTimeAgo($healthJobStatus.getEndDate())
        &lt;/div>
        &lt;div class="buttonwrapper">
          &lt;button id="admin_tools_job_start" type="submit" class="btn btn-primary" name="startHealthCheck"
            value="startHealthCheck">Start health check&lt;/button>
        &lt;/div>
      &lt;/div>
      &lt;div hidden class="xcontent job-status" data-url="${healthJobStatusURL}">
        #if ($healthJobStatus.state != 'FINISHED')
          #displayJobProgressBar($jobStatus)
        #else
          #jobFinishedMessage($healthJobStatus, $translationPrefix, $successKey, $errorKey, $canceledKey)
        #end
        #if ($showLogs || $isAdvancedUser || $isSuperAdmin)
          #if ($healthJobStatus.state != 'FINISHED')
            #displayJobStatusLog($jobStatus true)
          #else
            #displayJobStatusLog($healthJobStatus true)
          #end
        #end
      &lt;/div>
    &lt;/div>
  {{/html}}
#end
{{/velocity}}</content>
</xwikidoc>