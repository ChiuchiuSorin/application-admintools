<?xml version="1.1" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc version="1.5" reference="AdminTools.Code.Macros" locale="">
  <web>AdminTools.Code</web>
  <name>Macros</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <parent>AdminTools.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <version>1.1</version>
  <title>Macros</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity output='false'}}
#macro (viewLastNLinesMoldal $id)
  #set ($modalId = $id + 'ViewLastNLinesModal')
  &lt;div class="modal fade" id="${modalId}" tabindex="-1" role="dialog" aria-labelledby="${modalId}Label"&gt;
    &lt;div class="modal-dialog modal-sm" role="document"&gt;
      &lt;div class="modal-content"&gt;
        &lt;div class="logs-modal-content"&gt;
          &lt;div class="modal-header"&gt;
            &lt;button type="button" class="close" data-dismiss="modal" aria-label="Close"&gt;
              &lt;span aria-hidden="true"&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;
            &lt;h1 class="modal-title"&gt;
              $escapetool.xml($services.localization.render('adminTools.dashboard.logs.modal.title'))
            &lt;/h1&gt;
          &lt;/div&gt;
          &lt;div class="modal-body"&gt;
            &lt;form class="xform" action="$request.getContextPath()/rest/admintools/files/logs"&gt;
              &lt;dl&gt;
                &lt;dt&gt;
                  &lt;label for="noLines"&gt;$escapetool.xml($services.localization.render(
                    'adminTools.dashboard.logs.modal.nLines.label')) &lt;/label&gt;
                  &lt;span class="xHint"&gt;$escapetool.xml($services.localization.render(
                    'adminTools.dashboard.logs.modal.nLines.hint'))&lt;/span&gt;
                &lt;/dt&gt;
                &lt;dd&gt;&lt;input type="number" name="noLines" placeholder="1000"&gt;&lt;/dd&gt;
              &lt;/dl&gt;
            &lt;/form&gt;
          &lt;/div&gt;
          &lt;div class="modal-footer"&gt;
            &lt;button type="button" class="btn btn-primary"&gt;
              $escapetool.xml($services.localization.render('adminTools.dashboard.logs.modal.submit'))&lt;/button&gt;
            &lt;button type="button" class="btn btn-default" data-dismiss="modal"&gt;
              $escapetool.xml($services.localization.render('cancel'))&lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
#end

#macro (downloadArchiveModal)
  &lt;div class="modal fade" id="downloadFilesModal" tabindex="-1" role="dialog" aria-labelledby=
    "downloadFilesModalLabel"&gt;
    &lt;div class="modal-dialog" role="document"&gt;
      &lt;div class="modal-content"&gt;
        &lt;div class="modal-header"&gt;
          &lt;button type="button" class="close" data-dismiss="modal" aria-label="Close"&gt;
            &lt;span aria-hidden="true"&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;
          &lt;h1 class="modal-title"&gt;
            $escapetool.xml($services.localization.render('adminTools.dashboard.download.modal.title'))
          &lt;/h1&gt;
        &lt;/div&gt;
        &lt;div class="modal-body"&gt;
          &lt;form class="xform" action="$request.getContextPath()/rest/admintools/files"&gt;
            &lt;div class="download-modal-content"&gt;
              &lt;dl&gt;
                &lt;dt&gt;&lt;label&gt;&lt;input type="checkbox" name="files" value="xwikiConfig" checked&gt;
                    $escapetool.xml($services.localization.render(
                    'adminTools.dashboard.download.modal.xwikiConfig.title'))
                  &lt;/label&gt;
                &lt;/dt&gt;
                &lt;dt&gt;&lt;label&gt;&lt;input type="checkbox" name="files" value="xwikiProperties" checked&gt;
                    $escapetool.xml($services.localization.render(
                    'adminTools.dashboard.download.modal.xwikiProperties.title'))
                  &lt;/label&gt;
                &lt;/dt&gt;
                &lt;dt&gt;
                  &lt;label&gt;&lt;input type="checkbox" name="files" value="dataProvider" checked&gt;
                    $escapetool.xml($services.localization.render('adminTools.dashboard.download.modal.provided'))
                  &lt;/label&gt;
                &lt;/dt&gt;
                &lt;dt&gt;
                  &lt;label&gt;&lt;input type="checkbox" name="files" value="logs" checked&gt;
                    $escapetool.xml($services.localization.render('adminTools.dashboard.download.modal.logs.title'))
                  &lt;/label&gt;
                &lt;/dt&gt;
                &lt;dt&gt;
                  &lt;div class="dateFields"&gt;
                    #set ($defaultDateFormat = 'dd-MM-yyyy')
                    #set ($dateFormat = $xwiki.getXWikiPreference('dateformat', $defaultDateFormat))
                    &lt;label for="downloadFilesModalFromDate"&gt;$escapetool.xml($services.localization.render(
                      'adminTools.dashboard.download.modal.date.from'))
                    &lt;/label&gt;
                    #set ($dateFromParams = {
                      'id': "downloadFilesModalFromDate",
                      'name': 'from',
                      'data-format': $dateFormat,
                      'placeholder': $escapetool.xml($services.localization.render(
                        'adminTools.dashboard.download.modal.logs.filter.placeholder.from'))
                    })
                    #dateTimePicker($dateFromParams)
                    &lt;label for="downloadFilesModalToDate"&gt;$escapetool.xml($services.localization.render(
                      'adminTools.dashboard.download.modal.date.to'))
                    &lt;/label&gt;
                    #set ($dateToParams = {
                      'id': "downloadFilesModalToDate",
                      'name': 'to',
                      'data-format': $dateFormat,
                      'placeholder': $escapetool.xml($services.localization.render(
                        'adminTools.dashboard.download.modal.logs.filter.placeholder.to'))
                    })
                    #dateTimePicker($dateToParams)
                  &lt;/div&gt;
                &lt;/dt&gt;
              &lt;/dl&gt;
            &lt;/div&gt;
          &lt;/form&gt;
        &lt;/div&gt;
        &lt;div class="modal-footer"&gt;
          &lt;button type="button" class="btn btn-primary"&gt;
            $escapetool.xml($services.localization.render('adminTools.dashboard.download.modal.button'))&lt;/button&gt;
          &lt;button type="button" class="btn btn-default" data-dismiss="modal"&gt;
            $escapetool.xml($services.localization.render('cancel'))&lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
#end

#macro (jobFinishedMessage $status $translationPrefix $successKey $errorKey $canceledKey $warningKey)
  #if ($status.error)
    #set($messageKeys = [$errorKey, "${translationPrefix}.finish.error", "job.status.${status.jobType}.error",
    'job.status.error'])
    #set($healthCheckReportMessage = $services.localization.render($messageKeys))
    #set($messageClass = 'errormessage')
  #elseif ($status.canceled)
    #set($messageKeys = [$canceledKey, "${translationPrefix}.finish.canceled", "job.status.${status.jobType}.canceled",
    'job.status.canceled'])
    #set($healthCheckReportMessage = $services.localization.render($messageKeys))
    #set($messageClass = 'warningmessage')
  #elseif ($status.logTail.hasLogLevel('error'))
    #set($healthCheckReportMessage = 'Critical issues were found, please consult the log!')
    #set($messageClass = 'errormessage')
  #elseif ($status.logTail.hasLogLevel('warn'))
    #set($healthCheckReportMessage = 'Some issues have been found, for more details please see the log.')
    #set($messageClass = 'warningmessage')
  #else
    #set($healthCheckReportMessage = 'No issue found!')
    #set($messageClass = 'successmessage')
  #end
  &lt;div class="box $messageClass"&gt;
    $healthCheckReportMessage
  &lt;/div&gt;
#end

#macro (healthCheckUI)
  #set ($discard = $xwiki.jsx.use('AdminTools.Code.AdminToolsJS'))
  #set ($jobId = ['adminTools', 'healthcheck', $services.wiki.getCurrentWikiId()])
  #set ($healthJobStatusURL = $xwiki.getURL('AdminTools.Code.HealthCheckJob', 'get', $escapetool.url({
    'jobId': $jobId,
    'outputSyntax': 'plain'
  })))
  #if ($jobId)
    #set ($healthJobStatus = $services.job.getJobStatus($jobId))
  #end
  #set($solutionLink = $xwiki.getURL('AdminTools.HelpLinks'))
  #set ($description = $escapetool.xml($services.localization.render('adminTools.dashboard.healthcheck.description', [
    '__STARTLINK__',
    '__ENDLINK__'
  ])).replace('__STARTLINK__', "&lt;a href='$solutionLink'&gt;&lt;strong&gt;").replace('__ENDLINK__', '
    &lt;/strong&gt;&lt;/a&gt;'))
  &lt;jobState
    data-state="${healthJobStatus.state}"
  &lt;/jobState&gt;
  &lt;input type="hidden" name="jobState" value="${healthJobStatus.state}"&gt;&lt;/input&gt;
  &lt;div class="adminToolsDashboardItem" id="healthCheck"&gt;
    &lt;h2&gt;$services.icon.renderHTML('bug')
      $escapetool.xml($services.localization.render('adminTools.dashboard.healthcheck.title'))&lt;/h2&gt;
    &lt;p&gt;$description&lt;/p&gt;
    &lt;hr/&gt;
    &lt;div class="healthCheckWrapper"&gt;
      &lt;div class="healthCheckLastCheck"&gt;
        $escapetool.xml($services.localization.render('adminTools.dashboard.healthcheck.time')):
          $services.date.displayTimeAgo($healthJobStatus.getEndDate())
      &lt;/div&gt;
      &lt;div class="buttonwrapper"&gt;
        &lt;button id="admin_tools_job_start" type="submit" class="btn btn-primary" name="startHealthCheck"
          value="startHealthCheck"&gt;$escapetool.xml($services.localization.render(
            'adminTools.dashboard.healthcheck.start'))&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div hidden class="xcontent job-status" data-url="${healthJobStatusURL}"&gt;
      #if ($healthJobStatus.state != 'FINISHED')
        #displayJobProgressBar($jobStatus)
      #else
        #jobFinishedMessage($healthJobStatus, $translationPrefix, $successKey, $errorKey, $canceledKey)
      #end
      #if ($showLogs || $isAdvancedUser || $isSuperAdmin)
        #if ($healthJobStatus.state != 'FINISHED')
          #displayJobStatusLog($jobStatus true)
        #else
          #displayJobStatusLog($healthJobStatus true)
        #end
      #end
    &lt;/div&gt;
  &lt;/div&gt;
#end
{{/velocity}}</content>
</xwikidoc>
